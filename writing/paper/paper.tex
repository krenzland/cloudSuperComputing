\documentclass[runningheads]{llncs}
\title{Cloud Supercomputing}
\author{Lukas Krenz\inst{1} \and{} Leonhard Rannabauer\inst{1} \and{} Michael Bader\inst{1}}
\institute{Technical University of Munich} % todo emails and stuff
\usepackage[utf8]{inputenc}
%\usepackage[T1]{fontenc}
\usepackage[american]{babel}
\usepackage[autostyle, english = american]{csquotes}
\usepackage[%
  backend=biber,
  url=false,
  doi=false,
  % style=alphabetic,
  % backref=true,
  % hyperref=true,
  maxnames=3,
  % minnames=3,
  % maxbibnames=99,
  firstinits=true,
  % uniquename=init
  ]{biblatex}
\DefineBibliographyStrings{english}{%
  backrefpage = {see p.},
  backrefpages = {see pp.}
}
\addbibresource{../bibliography.bib}

\usepackage{caption}
\usepackage{xparse} % for NewDocumentCommand
\usepackage{etoolbox} % for notblank (brackets only when argument)
\usepackage{xstring} % for \IfSubStr
\usepackage{xpatch}
\usepackage{xcolor}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{mathtools} % for \mathclap
\usepackage{nicefrac}
\usepackage{physics} % for derivatives
\usepackage{varioref}
\usepackage{nicefrac}
\usepackage{physics} % for derivatives
\usepackage[separate-uncertainty]{siunitx}
\usepackage{hyperref}
\usepackage[noabbrev]{cleveref}
\newcommand{\creflastconjunction}{, and\nobreakspace} % use Oxford comma
\usepackage{todonotes}
\usepackage{multimedia}
\graphicspath{{../figures/}}
\let\boundary\undefined%
\crefformat{equation}{\eqA{}eq.~\eqB #2#1#3)}
% TODO: Fix for more than two equations!
\crefmultiformat{equation}{eqs.~\eqMultiA#2#1#3\eqMultiB}%
{ and \eqMultiA#2#1#3\eqMultiB}{, \eqMultiA#2#1#3\eqMultiB}{ and~\eqMultiA#2#1#3\eqMultiB}
\newcommand{\eqA}{}
\newcommand{\eqB}{(}
\newcommand{\eqMultiA}{(}
\newcommand{\eqMultiB}{)}
\DeclareRobustCommand{\pcrefSingle}[1]{%
\begingroup%
  \renewcommand{\eqA}{(}\renewcommand{\eqB}{}%
\cref{#1}%
\endgroup%
}
\DeclareRobustCommand{\pcrefMulti}[1]{%
\begingroup%
    \renewcommand{\eqMultiA}{}\renewcommand{\eqMultiB}{}%
    (\cref{#1})%
\endgroup%
}
\DeclareRobustCommand{\pcref}[1]{%
\IfSubStr{#1}{,}{\pcrefMulti{#1}}{\pcrefSingle{#1}}%
}

\usepackage{bm}
\input{../thesis/macros.tex}


\begin{document}
\maketitle
\begin{abstract}

\begin{itemize}
\item Implementation of compressible Navier Stokes with a high-order \aderdg{}-method and a low order finite volume \muscl{}-scheme.
\item Implementation in \exahypeengine{}, a scalable \pde{} framework.
\item Outlier and total variation based adaptive mesh refinement that reduced number of grid cells drastically and preserves solution quality.
\item Simulation of challenging flows over hydrostatic background atmosphere.
\item Competitive results for both classical cfd scenarios and hydrostatic scenarios in two and three dimensions.
\end{itemize}
  
The abstract should briefly summarize the contents of the paper in
150--250 words.

\keywords{\aderdg{}  \and Navier-Stokes \and Another keyword.}
\end{abstract}
\section{Introduction}

Insert references to Giraldo SE/DG bubbles~\cite{giraldo2008study}, 3D bubbles~\cite{giraldo2013implicit,kelly2012continuous}, bubble amr (müller~\cite{muller2010adaptive}).

In this paper we use the \aderdg{} method of~\cite{dumbser2008unified} to simulate various computational fluid dynamics (\textsc{cfd}) scenarios with a focus on hydrostatic flows\todo{LK: Heißt das so?}.
To include viscosity\todo{MB: viscosity ist unmotiviert ist.
  Lieber noch so 10--15 Zeilen drüber schreiben.}, we use the numerical flux of \citeauthor{gassner2008discontinuous}~\cite{gassner2008discontinuous} to include the parabolic terms of the compressible Navier-Stokes equations.
This flux has already been applied to the \aderdg{} method in~\cite{dumbser2010arbitrary}.
\todo{Einordnung, Kontext zu giraldo, etc$\ldots$}

We utilize the \exahypeengine{} (\url{www.exahype.eu}) which is a framework that can solve arbitrary hyperbolic partial differential equations.
A user of the engine is provided with a simple code interface which mirrors the parts required to formulate a well posed Cauchy problem for a system of hyperbolic \pde{}s of first order.
The underlying \aderdg{} method\todo{\muscl{}?}, parallelization techniques and dynamic adaptive mesh refinement are available for simulations while the implementations are left as a black box to the user.
An introduction to the communication-avoiding implementation of the whole numerical scheme can be found in the recent work~\cite{charrier2018stop} by \citeauthor{charrier2018stop}.

We make the following contributions\todo{Feedback von MB: Besser hervorheben, warum diese Sachen interessant/neu sind.
Dumbser macht in seinen NS-DG papern keine komplexen Source terme, keine hydrostatic flows, etc.
}:
\begin{itemize}%
\item We extend the \exahypeengine{} to allow viscous terms following the aforementioned numerical scheme.
\item We use this to provide an implementation of the compressible Navier-Stokes equations.
\item We show an \textsc{amr}-criterion that is based on the detection of outlier cells w.r.t.\ their total variation.
\item We evaluate our implementation with standard \textsc{cfd} scenarios and atmospheric flows and inspect the effectiveness of our proposed \amr{}-criterion.
\end{itemize}

\section{Equation Set}
\newcommand{\diffCoeff}{\varepsilon}%
\newcommand{\hyperFluxDef}{
  \begin{pmatrix}
    \Qj \\
    \Qv  \otimes \Qj + \bm{I} \pressure  \\
    \Qv \cdot (\bm{I} \QE + \bm{I} \pressure)
  \end{pmatrix}
}%
\newcommand{\viscFluxDef}{
  \begin{pmatrix}
    0\\
     \stressT (\Q, \gradQ)  \\
     \Qv \cdot \stressT (\Q, \gradQ) - \kappa \gradient{T}
   \end{pmatrix}
}%
The compressible Navier-Stokes equations in the conservative form are defined as% \pcref{eq:conservation-law-gradient}
\begin{equation}
 \label{eq:equation-set} 
%  \begin{array}{l}
%  \text{mass cons.} \\
%  \text{momentum cons.} \\
%  \text{energy cons.} \\
%  \text{cont.\ gas} 
% \end{array}
% :
\quad
  \pdv{}{t}
  \underbrace{
  \begin{pmatrix}
    \Qrho\\
    \Qj\\
    \QE
    \end{pmatrix}}_{\Q}
  +
  \divergence{
  \underbrace{
  \left(
   \underbrace{\hyperFluxDef}_{\hyperFlux(\Q)}
+
\underbrace{\viscFluxDef}_{\viscFlux(\Q, \gradQ)}
  \right)}_{\flux(\Q, \gradQ)}}
 =
  \underbrace{
  \begin{pmatrix}
    \source[\Qrho\phantom{\Qrho}]\\
    \source[\Qj]\\
    \source[\QE]
    \end{pmatrix}}_{\source(\Q, \bm{x}, t)}
\end{equation}
with vector of conserved quantities $\Q$, flux $\flux(\Q, \gradQ)$ and source $\source(\Q)$.
Note that the flux can be split into a hyperbolic part $\hyperFlux(\Q)$,
which is identical to the flux of the Euler equations,
and a viscous part $\viscFlux(\Q, \gradQ)$.
The conserved quantities
\(\Q\)
% \begin{equation} 
%   \label{eq:conserved-variables}
%  \Q = \left( \Qrho, \Qj, \QE, \QZ \right),
% \end{equation}
are the density $\Qrho$, the two or three-dimensional momentum $\Qj$ and the energy density $\QE$.
The rows of \cref{eq:equation-set} are the conservation of mass, the conservation of momentum and the conservation of energy.

The pressure $\pressure$ is given by the equation of state of an ideal gas
\begin{equation}
  \label{eq:eos}
  \pressure = (\gamma - 1) \left(\QE - \frac{1}{2} \left(\Qv \cdot \Qj \right) - gz \right).
\end{equation}
The term $gz$ is the geopotential height with the gravity of Earth $g$~\cite{giraldo2008study}.
The temperature $T$ relates to the pressure by the thermal equation of state
\begin{equation}
  \label{eq:temperature}
  \pressure = \Qrho R T,
\end{equation}
where $R$ is the specific gas constant of a fluid.

We model the diffusivity by the stress tensor
\begin{equation}
  \label{eq:stress-tensor}
  \stressT(\Q, \gradQ) =
  \mu
  \left(
  \left(\nicefrac{2}{3} \divergence{\Qv} \right) -
  \left( \gradient{\Qv} + \gradient{\Qv}^\intercal \right)
  \right),
\end{equation}
with constant viscosity $\mu$.
The heat diffusion is governed by the coefficient
\begin{equation}
  \label{eq:heat-conduction-coeff}
  \kappa = \frac{\mu \gamma}{\Pr} \frac{1}{\gamma - 1} R = \frac{\mu c_p}{\Pr},
\end{equation}
where the ratio of specific heats $\gamma$, the heat capacity at constant pressure $c_p$ and the Prandtl number $\Pr$ depend on the fluid.

Many realistic atmospheric flows can be described by a perturbation over a background state that is in hydrostatic equilibrium\todo{Mention source}
\newcommand{\backgroundPressure}{\overline{\pressure}}
\newcommand{\backgroundRho}{\overline{\Qrho}}
\begin{equation}
  \label{eq:hydrostatic-balance}
  \pdv{}{z} \backgroundPressure{\left (z \right )} = -g \backgroundRho(z),
\end{equation}
i.e.\ a state, where the pressure gradient is exactly in balance with the gravitational source term.
The momentum equation is dominated by the background flow in this case.
This can lead to numerical instabilities.
To avoid this, we split the pressure $\pressure = \backgroundPressure + \pressure'$ into a sum of the background pressure $\backgroundPressure(z)$ and perturbation $\pressure'(\bm{x}, t)$.
We split the density $\Qrho = \backgroundRho + \Qrho'$ in the same manner and arrive at
\begin{equation}
  \label{eq:momentum-equation-split}
  \pdv{\Qj}{t}+ \divergence{ \left(
    \Qv \otimes \Qj + \bm{I} \pressure'
    \right)
  } + \viscFlux_\Qj
  =
  -g \bm{k} \Qrho'.
\end{equation}
Note that a smilar splitting is performed in~\cite{muller2010adaptive,giraldo2008study}.
\todo{Mention differences in splitting methods}
\section{Numerics}

\todo{LR: Hier würde ich noch ein paar einleitende Worte hinzufügen}
\todo{LK: CFL? Riemannsolver (no gradients)}
We use an \aderdg{}-scheme and a \muscl{} finite volume method.
Both can be considered as instances of the more general \textsc{PnPm} schemes of~\cite{dumbser2008unified}.
We use a Rusanov-style flux that is adapted to \pde{}s with viscous terms~\cite{gassner2008discontinuous,fambri2017space}.
The finite volume scheme is stabilized with the van Albada limiter\todo{LK: Which one is best? Cite vanalbada}.

The user can state dynamic \amr{} rules by supplying custom criteria that are evaluated point-wise.
We use an element local error estimate based on the total variation of the numerical solution. 
Let $\bm{f}(\bm{x}): \mathbb{R}^{N_\text{vars}} \to \mathbb{R}$ be a sufficiently smooth function that maps the discrete solution at a point $\bm{x}$ to an arbitrary indicator variable.
The total variation (\textsc{tv}) of this function is defined by
\begin{equation}
  \label{eq:tv}
  \tv \left[ f(\bm{x}) \right] =
  \Vert
\intdcell{ \vert \gradient{f \left( \bm{x} \right)} \vert }
\Vert_1
\end{equation}
for each cell.
The operator $\Vert \cdot \Vert_1$ denotes the discrete $l_1$ norm in this equation.
We compute the integral efficiently with Gaussian quadrature over the collocated quadrature points.
\todo{LK: If using limiting, add sentence about tv computation for fv}
\newcommand{\mean}{\mu}%
\newcommand{\std}{\sigma}%
\newcommand{\variance}{\std^2}%
\newcommand{\Trefine}{T_\text{refine}}%
\newcommand{\Tdelete}{T_\text{erase}}%
How can we decide whether a cell is important or not?
To resolve this conundrum, we compute the mean and the population standard deviation of the total variation of all cells.
It is important to note that we use the method of~\cite{chan1982updating} to compute the modes in a parallel and numerical stable manner.
A cell is then considered to contain significant information if its deviates from the mean more than a given threshold.
This criterion can be described formally by
\begin{equation}
  \label{eq:refinement-criterion}
  \operatorname{evaluate-refinement}(\Q, \mu, \sigma) =
  \begin{cases}
    \text{refine} & \text{if } \tv(\Q) \geq \mu + \Trefine \sigma, \\
    \text{erase} & \text{if } \tv(\Q) < \mu + \Tdelete \sigma, \\
    \text{keep} & \text{otherwise}.
    \end{cases}
\end{equation}
The parameters $\Trefine > \Tdelete$ can be chosen freely.
Chebyshev's inequality
\begin{equation}
  \label{eq:chebychev}
  \mathbb{P}(\vert X - \mu \vert \geq c \sigma) \leq \frac{1}{c^2},
\end{equation}
with probability $\mathbb{P}$ guarantees that we neither mark all cells for refinement nor for erasement.
\todo{LR: Was gibt es an compressible NS mit dynamic AMR, wie unterscheiden wir uns im Refinement Kriterium?}
This inequality holds for arbitrary distributions under the weak assumption that they have a finite mean $\mu$ and a finite standard deviation $\sigma$~\cite{wasserman2004all}.
Note that subcells are coarsened only if all subcells belonging to the coarse cell are marked for erasion.

We use a \muscl{} based finite volume limiting as proposed in~\cite{dumbser2016simple}.
Briefly, we first compute a candidate solution with our \aderdg{}-scheme and check whether it is valid.
A solution is considered to be invalid if it is a non-finite floating point number or if it is unphysical, i.e.\ if the pressure or density are not positive.
\todo{LK: Mention dmp if using, mention tv-indicator for limiting if using}
In case of an invalid solution, we recompute the timestep with a our \muscl{} finite volume method.\todo{Source for the fv method}

\section{Results}
We use a diverse mix of benchmarking scenarios that consist of standard \textsc{cfd} scenarios and atmospheric flows.

\todo{LK: Constants of fluids?}
A simple scenario is the Taylor-Green vortex.
It has an analytical solution in the incompressible limit which is given by
\begin{align}
  \label{eq:taylor-green}
  \begin{split}
  \Qrho(\bm{x}, t) &= 1,\\
  \Qv(\bm{x}, t) &= \exp(-2 \mu t)
  \begin{pmatrix}
    \phantom{-}\sin(x) \cos(y) \\
- \cos(x) \sin(y) 
    \end{pmatrix}, \\
  \pressure(\bm{x}, t) &= \exp(-4 \mu t) \, \nicefrac{1}{4} \left( \cos(2x) + \cos(2y) \right) + C.
  \end{split}
\end{align}
The constant $C = \nicefrac{100}{\gamma}$ governs the speed of sound and thus the Mach number~\cite{dumbser2016high}, the viscosity is set to $\mu = 0.1$.
We use a domain of size $(\SI{2 \pi}{\m} \times \SI{2 \pi}{\m})$ and impose the analytical solution at the boundary\todo{tEnd, mach=0.1}.

We use the Arnold-Beltrami-Childress (\textsc{abc}) flow as a simple three-dimensional flow~\cite{tavelli2016staggered}.
It also has an exact solution in the domain of \( \left[ -\SI{\pi}{\m}, \SI{\pi}{\m} \right]^3 \) under the assumption of incompressibility
\begin{align}
  \label{eq:abc-flow}
  \begin{split}
  \Qrho(\bm{x}, t) &= 1,\\
  \Qv(\bm{x}, t) &= \phantom{-} \exp(-1\mu t)
  \begin{pmatrix}
    \sin(z) + \cos(y)\\
    \sin(x) + \cos(z)\\
    \sin(y) + \cos(x)
  \end{pmatrix}, \\
  \pressure(\bm{x}, t) &= -\exp(-2 \mu t) \, \left(\cos(x)\sin(y) + \sin(x)\cos(z) + \sin(z)\cos(y)\right)
  + C.
  \end{split}
\end{align}
The constant $C = \nicefrac{100}{\gamma}$ is chosen as before.
We use a viscosity of $\mu = 0.01$ and analytical boundary conditions\todo{tEnd}.

As a final example of standard flow scenarios, we consider the lid-driven cavity flow where the fluid is initially at rest, with $\Qrho = 1$ and $ \pressure(\bm{x}) = \nicefrac{100}{\gamma}$.
We consider a domain of size $\SI{1}{m} \times \SI{1}{\m}$ which is surrounded by no-slip walls.
The flow is driven entirely by the upper wall which has a velocity of $v_x = \SI{1}{\m/\s}$.
The simulation runs for $\SI{10}{\s}$

Our atmospheric flow scenarios are described in terms of the potential energy
\begin{equation}
  \potT = T \left( \frac{p_0}{p} \right)^{R/c_p},
\end{equation}
with reference pressure $p_o$~\cite{muller2010adaptive,giraldo2008study}.
We use the constants
\begin{equation}\label{eq:atmosphere-constants}
    \gamma = 1.4 ,\qquad \Pr =  0.71 ,\qquad R = 287.058 ,\qquad p_0 = \SI{10e5}{\Pa}, \qquad g = \SI{9.8}{m/s^2},
\end{equation}
for all remaining scenarios.

We compute the initial background density and pressure by inserting the assumption of a constant background energy in \cref{eq:hydrostatic-balance}.
The background atmosphere is then perturbed.
\todo{LK: Mention bcs briefly?}
Let
\begin{equation}
  \label{eq:radius}
  r^2 = (x - x_0)^2 + (z - z_0)^2
\end{equation}
denote the difference between spatial positions $x,z$ and the center of a bubble $x_c, z_c$\todo{3D}.
For our first scenario, the cosine bubble, we use a pertubation of the form
% \begin{equation}
%   \label{eq:cos-pertubation-alt}
%   \pertubationPotT = 
%     \nicefrac{A}{2} \left( 1 + \cos(\pi r) \right) \left[ r \leq a \right]
% \end{equation}
\begin{align}
  \label{eq:cos-pertubation}
  \pertubationPotT &= \begin{cases}
    \nicefrac{A}{2} \left[ 1 + \cos(\pi r) \right] & r \leq a, \\
    0 & r > a,
    \end{cases}
\end{align}
where $A$ denotes the maximal perturbation and $a$ is the size of the bubble.
We use the constants\todo{3d bubble is higher}
\begin{equation}\label{eq:cosine-bubble}
  A = \SI{0.5}{\K} \quad a = \SI{250}{\m} \quad x_c = \SI{500}{\m} \quad z_c = \SI{350}{\m}.
\end{equation}
We use a constant viscosity of $\mu = 0.1$\todo{tend = 400 for 3d and 600 for 2d}.
For our second scenario, the colliding bubbles, we use perturbations of the form
\begin{equation}
  \label{eq:bubbles-pertubation}
  \pertubationPotT =
  \begin{cases}
    A & r \leq a, \\
    A \exp \left( - \frac{(r-a)^2}{s^2} \right) & r > a,
    \end{cases}
\end{equation}
where $s$ is the decay rate and $r$  is the radius to the center~\pcref{eq:radius}.
We have two bubbles, with constants
\begin{equation}
  \label{eq:bubbles-values}
\begin{alignedat}{6}
  & \text{warm:} \qquad && A = \SI{0.5}{\K}, \quad&& a = \SI{150}{\m}, \quad&& s = \SI{50}{\m}, \quad&& x_c = \SI{500}{\m,} \quad&& z_c = \SI{300}{\m},\\
  & \text{cold:} \qquad && A = \SI{-0.15}{\K}, \quad&& a = \SI{0}{\m}, \quad&& s = \SI{50}{\m}, \quad&& x_c = \SI{560}{\m}, \quad&& z_c = \SI{640}{\m}.
  \end{alignedat}
\end{equation}
Similar to~\cite{muller2010adaptive} and to the previous scenario, we use a constant viscosity of $\mu = 0.1$ to regularize the solution.
To ensure that the atmosphere stays in hydrostatic balance~\cite{giraldo2008study}, we need to impose the viscous heat flux
\begin{equation}
  \label{eq:atmosphere-bc}
  \viscFlux_{\QE} = \kappa \pdv{\overline{T}}{z}.% =
%\kappa \frac{R \overline{\theta} \left(\frac{\overline{p}{\left (z \right )}}{p_{0}}\right)^{\frac{R}{c_{p}}} \frac{d}{d z} \overline{p}{\left (z \right )}}{c_{p} \overline{p}{\left (z \right )}}.
\end{equation}
where $\overline{T}(z)$ is the background temperature at position $z$ which can be computed from \cref{eq:hydrostatic-balance,eq:eos}.
We furthermore set the density and energy at the boundary such that it corresponds to the background atmosphere.

% We start with a coarse mesh that is then subdivided up to two times in an adaptive manner.
% For this we use the criterion of \cref{eq:refinement-criterion} with parameters xxx and xxx.
% We compare this with a simulation obtained by a fully refined grid.

Show following results:
\begin{itemize}
\item Simple cfd: Taylor Green, ABC, Lid Driven Cavity
\item Two Bubbles with \amr{} (2 levels if possible) and no \amr{} (comparison)
\item Two Bubbles (Euler eqs, FV)  
\item Two Bubbles with limiting instead of visc.\ if working  
\item Cosine bubble in 2D and possibly 3D, if working
\end{itemize}

\section{Conclusion}
We presented our implementation of a \muscl{}-limited \aderdg{}-scheme with \amr{} for the Navier-Stokes equations.
Our implementation is capable of simulating different scenarios:
\begin{itemize}
  % Convergence test?
\item We evaluated our method for standard \textsc{cfd} scenarios and achieved competitive results for all used scenarios.
  This is true for both two-dimensional scenarios (Taylor-Green vortex and lid-driven cavity) and for the three-dimensional \textsc{abc}-flow.
\item Furthermore, our method allows us to simulate flows in hydrostatic equilibrium correctly as our results for the cosine and colliding bubble scenarios showed.
\item We showed that our \amr{}-criterion is able to vastly reduce the number of grid cells while preserving the quality of the results.
\end{itemize}
\todo{LK: Flesh this out a tiny bit, mention properties of \amr{} criterion}

\subsection*{Acknowledgements}
Lukas Krenz was funded by ChEESE (823844), Leonhard Rannabauer was funded by ExaHyPE (671698).
\todo{LK: Standard sentence is: This research was funded by the European Union’s Horizon 2020 Research and Innovation Programme under theproject ExaHyPE, grant no.  671698 (call FETHPC-1-2014).

Also LRZ?}


\printbibliography{}
\end{document}
