\chapter{Methods}
Methods here.\todo{Organize into chapters!}

% TODO: Extract to settings.tex
\newcommand{\Qrho}{\rho}
\newcommand{\Qj}{\rho \bm{v}}
%\newcommand{\Qv}{\ensuremath{\Qrho^{-1} \Qj}}
\newcommand{\Qv}{\bm{v}}
\newcommand{\QE}{\rho E}
\newcommand{\stressT}{\bm{\sigma}}
\newcommand{\pressure}{p}
\newcommand{\maxConvEigen}{\vert \lambda_c^{\text{max}} \vert}
\newcommand{\maxViscEigen}{\vert \lambda_v^{\text{max}} \vert}

\newcommand{\domain}{\Omega}
\newcommand{\broken}{\domain}
\newcommand{\cell}[1][i]{C_{#1}}
\newcommand{\boundary}{\partial \domain}
\newcommand{\sbasis}[1]{\Phi_{#1}}
\newcommand{\testfunction}[1]{\Phi_{#1}}

\section{Conservative Form}
Standard (hyperbolic) form of conservation law
\begin{equation}
  \label{eq:conservation-law}
 \frac{\partial}{\partial_t}  Q + \div \cdot F(Q) = S(\bm{x}, t, Q)
\end{equation}
extend to:
\begin{equation}
  \label{eq:conservation-law-gradient}
 \frac{\partial}{\partial_t}  Q + \div \cdot F(Q, \grad Q) = S(\bm{x}, t, Q)
\end{equation}

\section{The ADER-DG Method}
\label{sec:ader-dg}
We describe the arbitrary derivative discontinous Galerkin (ADER-DG) method in this chapter.

We discuss the solution of a hyperbolic conservation law \cref{eq:conservation-law} with domain $\domain$ and boundary $boundary$.
In the discontinous Galerkin (DG) framework, we approximate this solution in the space
\begin{equation}
  \label{eq:dg-space}
  \broken = \bigcup_i \cell
\end{equation}
of disjoint quadrilateral cells $\cell$.
Note that we do not distinguish between the approximation space and the domain, the use should be clear given its surrounding context.
In the following we make use of the Einstein summation convention where summation over repeated indexes is implied.

Inside each cell $\cell$ we represent the solution in terms of the basis function 
\begin{equation}
  \label{eq:cell-approx}
  u(\bm{x}, t^n)_{|\cell[i]} = \hat{u}^n_{i,l} \sbasis{l}{\bm{x}},
\end{equation}
where $l$ is a multi-index, containing one index per spatial dimension.
\todo{dofs $\hat{u}$. local solution, etc.}
For example, $(l = (l_1, l_2))$ for the two dimensional case.
This polynomial is interpolating, i.e.\ \ldots\todo{interpolating?}.
This choice of basis (called \textit{nodal} basis) allows us to easily compute integrals over cells using Gaussian quadrature.
In detail, we use a the Lagrange interpolation polynomials.

We now describe the derivation of the \textsc{ader-dg} method.
This scheme is a predictor-corrector method.
We first compute a local solution of the cell in the predictor step and then connect with the neighbors in the corrector step.
In the following we first describe the corrector step as it follows directly from the \textsc{pde}.
The predictor is derived shortly after.

\sidetitle{Corrector}
First, we multiply the system \cref{eq:conservation-law} by a test function $\testfunction{i}$ and integrate over the space-time volume $(\cell \times [t^n, t^{n+1}])$.
We arrive at the so called weak formulation of the \textsc{pde} 
\newcommand{\intdt}[1]{\int_{t^n}^{t^{n+1}} #1 \dd{t}}
\newcommand{\intdcell}[1]{\int_{\cell} #1 \dd{\bm{x}}}
\newcommand{\intdcellb}[1]{\int_{\partial{} \cell} #1 \dd{S}} % TODO: define boundary of cell
\begin{equation}
  \label{eq:weak-pde}
\intdt{\intdcell{
\testfunction{k} \pdv{\bm{Q}}{t}
}}
+
\intdt{\intdcell{
    \testfunction{k} \left( \div{F(Q, \gradient{Q})} \right)
}}
=
\intdt{\intdcell{
    \testfunction{k} S(Q, \bm{x}, t)
}}
\end{equation}
\todo{Include gradient everywhere!}
\todo{Double check the following description}
\newcommand{\stpredictor}[1]{\bm{q}_{#1}}
We now replace the solution $\bm{Q}$ with so called spacetime-predictor $\stpredictor{h}(\bm{x},t)$ into the weak form and write it as a polynomial using the representation of \cref{eq:cell-approx}.
Integrate first by parts in time (note basis here not defined over time), flux divergence by parts in space.
\begin{align}
\begin{split}
\label{eq:corrector}
\left(
\intdcell{
  \testfunction{k} \sbasis{l}
}
\right)
\left(\intdt{\intdcellb{
\text{dofs boundary time}
}}\right)
&+\\
\left(\intdt{\intdcell{
\text{Riemann}
}}\right)
-
\left(\intdt{\intdcell{
\text{Flux}
}}\right)
&=
\left(\intdt{\intdcell{
  \text{Source}
}}\right)
\end{split}
\end{align}
The first term motivates an orthogonal basis as this leads to a diagonal mass matrix.


\sidetitle{Predictor}
To derive the predictor, we again take an approximation of our solution in a nodal basis, but now consider polynomials that are defined both in space and time.
\begin{equation}
  \ldots
\end{equation}
We know multiply the conservation law again by a test function (of the same function space as the basis) and arrive at the weak formulation
\begin{equation}
  \label{eq:weak-pde-space-time}
 \ldots
\end{equation}
Similar to the derivation of the corrector, we again integrate the first term by parts in time and the flux divergence in space.
This time we do not use the Riemann solver for the flux boundary term but rather use the discrete solution at time $t$.
Note that this neglects the interaction with neighbouring cells; this is corrected in the corrector step.

\begin{equation}
  \label{eq:space-time-predictor}
  \ldots
\end{equation}
Inserting \cref{eq:cell-approx-space-time} results in a local systems of equations that can be solved in a fixed point iteration scheme.
For details and proof of convergence for the linear case, see (todo).
Write about initial guess (we use naive one anyway, right?)

\sidetitle{Boundary extrapolation and stuff}
Extrapolate unknowns to boundary, convert from our basis to basis on faces.
Then Riemann solver
and so on

\sidetitle{Full Scheme}
Maybe write algorithm?


\todo{Actually write this section\ldots}


\section{Compressible Euler}
Vector of conserved quantities:
\begin{equation}
  \label{eq:conserved-variables}
 Q = \left( \Qrho, \Qj, \QE \right) 
\end{equation}

\newcommand{\eulerFlux}{%
  \begin{pmatrix}
    \Qj \\
    \Qv  \otimes \Qj + \pressure \bm{I}  \\
    \Qv \cdot (\bm{I} \QE + \bm{I} \pressure)
  }
Flux:
\begin{equation}
  F(Q) = \eulerFlux
  \end{pmatrix}
\end{equation}
\begin{equation}
  \pressure = (\gamma - 1) \left(\QE - 0.5 \left(\Qv \cdot \Qj \right) \right)
\end{equation}

\section{Compressible Navier Stokes}
Following~\cite{dumbser2010arbitrary} by \citeauthor{dumbser2010arbitrary}.

The full compressible Navier Stokes equations with heat transfer can be described by
\begin{equation}
  F(Q, \nabla Q) = 
  \begin{pmatrix}
    \Qj \\
    \Qv  \otimes \Qj + \bm{I} \pressure + \stressT (Q, \nabla Q)  \\
    \Qv \cdot (\bm{I} \QE + \bm{I} \pressure + \stressT (Q, \nabla Q)) - \kappa \nabla T
  \end{pmatrix},
\end{equation}
where $\pressure$, $\stressT$ and $(\kappa \nabla T)$ denote the pressure, stress tensor and heat flux respectively.
Temperature is denoted by $T$.

We use the equation of state of an ideal gas
\begin{equation}
  \pressure = (\gamma - 1) \left(\QE - 0.5 \left(\Qv \cdot \Qj \right) \right).
\end{equation}
The temperature $T$ relates to pressure and density by the ideal gas law
\begin{equation}
  \label{eq:temperature}
 \frac{\pressure}{\Qrho} = RT,
\end{equation}
where $R$ is the specific gas constant.

\todo{Write more text about constants, cite idolikecfd or sth}
\begin{align}
  c_v &= \frac{1}{\gamma - 1} R \\
  c_p &= \frac{\gamma}{\gamma - 1} R\\
  R &= c_p - c_v\\
  \gamma &= \frac{c_p}{c_v}
\end{align}

Heat conduction coefficient $\kappa$
\begin{equation}
  \label{eq:heat-conduction-coeff}
  \kappa = \frac{\mu \gamma}{\Pr} \frac{1}{\gamma - 1} R
\end{equation}
with $R$ gas constant and $\Pr$ Prandtl number

% Sutherland's viscosity law:
% \begin{equation}
%   \label{eq:sutherland}
%  \mu(T)  = \mu_0 {\left(\frac{T}{T_0}  \right)}^{\beta} \frac{T_0 + C}{T + C}
% \end{equation}
% with \(\beta = 1.5\), \(C = \text{const.}\), reference temperature $T_0$ and reference viscosity $\mu_=$.
% Equal to
% \begin{align}
%   \lambda &= \frac{\mu_0 (T_0 + C)}{T_0^\beta} \\
%   \mu(T) &= \lambda \frac{T^\beta}{T + C},
% \end{align}
% where $\lambda$ is constant for a given fluid.

The viscous effects are modeled by the stress tensor
\begin{equation}
  \label{eq:stress-tensor}
  \stressT(Q, \nabla Q) = \left(\nicefrac{2}{3} \mu \nabla \cdot \Qv \right) -
  \mu \left( \nabla (\Qv) + \nabla ( \Qv )^\intercal \right).
\end{equation}

\subsection{Boundary conditions}
To close the system we need to impose boundary conditions.

For some scenarios we use Cauchy boundary conditions.
In most cases, we would like to impose periodic boundary conditions, due to the inner workings of ExaHyPE this is not possible.
Instead we use the analytical solution of our problems at the boundary, imposing both value and gradients of the conservative variables.
Note that this leads to an error when our problem does not posses an exact analytical solution.
This is the case for test cases that are analytical solutions to the incompressible Navier Stokes equations but do not satisfy the compressible equation set.

As a physical boundary condition we limit ourselves to the no-slip boundary condition, where we assume that the fluid has a velocity of zero near the wall.
\todo{Check if this is the correct physical description!}
We enfore this by setting
\begin{align}
  \Qrho^o &= \Qrho^i, \\
  \Qj^o &= -\Qj^i, \\
  \QE^0 &= \QE^i,\\
  {(\nabla Q)}^o &= {(\nabla Q)}^i,
\end{align}
where a superscript of $o$ and $i$ denotes the values outside and inside of the boundary respectively.


\subsection{Diffusive Flux stuff}
Max eigenvalue of convective part $\maxConvEigen$,i.e.\ of $\left( \partial \bm{F}/\partial \bm{Q}\right) \cdot \bm{n}$,
and viscous part $maxViscEigen$, i.e.\ of $\left( \partial \bm{F}/\partial \left( \nabla \bm{Q} \cdot \bm{n} \right)\right) \cdot \bm{n}$
is
\begin{align}
  \maxConvEigen \vert  &= \Vert \Qv \Vert + c\\
  \maxViscEigen \vert &= \max \left( \frac{4}{3} \frac{\mu}{\Qrho}
                                       , \frac{\gamma \mu}{\Pr \Qrho} \right)
\end{align}
with speed of sound $c = \sqrt{\gamma R T }$

Maximum timestep (\textsc{cfl})
\begin{equation}
 \Delta t = \frac{\text{CFL}}{2N + 1} \, \frac{h}{\maxConvEigen + 2 \maxViscEigen \frac{2N+1}{h}}
\end{equation}
with $N$ polynomial order and $h$ characteristic length scale of elements

Numerical flux:
\begin{equation}
  \label{eq:rusanov-flux}
  G(q_h^-, \nabla q_h^-; g_h^+, \nabla q_h^+) \cdot \bm{n} =
  \frac{1}{2} \left(
    F(q_h^+, \nabla q_h^+) +
    F(q_h^-, \nabla q_h^-)
  \right) -
  \frac{1}{2} s_\text{max} (q_h^+ - q_h^-)
\end{equation}
with
\begin{equation}
  \label{eq:parabolic-penalty}
  s_\text{max}  = \max \left(
\vert \lambda_c(q_h^-) \vert, \, \vert \lambda_c(q_h^+)
\right) +
2 \eta \max \left(
\vert \lambda_v(q_h^-) \vert, \, \vert \lambda_v(q_h^+)
\right)
\end{equation}
and
\begin{equation}
  \eta = \frac{N+1}{h}
\end{equation}


\section{Scenarios}
\label{sec:scenarios}

\subsection{Clouds}
Air is initially at rest and in hydrostractic balance
\begin{equation}
  \label{eq:hydrostatic-balance}
 \pdv{p (z)}{z} = -\rho(z) g.
\end{equation}
Inserting \cref{eq:temperature} leads to the \textsc{ode}
\begin{equation}
  \pdv{p(z)}{z} = - \frac{p(z)}{RT} g,
\end{equation}
which can be solved by seperation of variables.
This results in the equation
\begin{equation}
  \label{eq:bubble-pressure}
  p(z) = c \exp \left( - \frac{gz}{RT} \right),
\end{equation}
where the constant of integration $c$ can be found by considering the case
\begin{equation}
  p(0) = c.
\end{equation}

The scenario is described in terms of potential temperature $\theta$
\begin{equation}
  \theta = T \frac{p_0}{p}^{R/c_p},
\end{equation}
where $p_o = \SI{10e5}{\Pa}$ is the reference pressure.
Solving for $T$ leads to
\begin{equation}
  T = \theta (\frac{p}{p_0})^{R/c_p}.
\end{equation}

Note: Above approach leads to wrong atmosphere, rather do (with constant potential temperature):
Equation of state with potential temperature:
\begin{equation}
  \label{eq:eos}
\Qrho(z) = \frac{p_{0}^{\frac{c_{p} - c_{v}}{c_{p}}} p^{\frac{c_{v}}{c_{p}}}{\left (z \right )}}{R \theta}
\end{equation}
Hydrostatic equilibrium with potential temperature:
\begin{equation}
  \label{eq:hydrostatic-balance-potT}
  \frac{d}{d z} p{\left (z \right )} = - \frac{g p_{0}^{\frac{R}{c_{p}}} p^{\frac{1}{\gamma}}{\left (z \right )}}{R \theta}
\end{equation}
Solution for pressure with initial condition of $p(0) = p_0$:
% \begin{equation*}
% p = \left(\frac{R \gamma \theta \left(\gamma^{\frac{\gamma}{\gamma - 1}} p_{0}\right)^{\frac{\gamma - 1}{\gamma}} - R \theta \left(\gamma^{\frac{\gamma}{\gamma - 1}} p_{0}\right)^{\frac{\gamma - 1}{\gamma}} - g \gamma p_{0}^{\frac{R}{c_{p}}} z \left(\gamma - 1\right) + g p_{0}^{\frac{R}{c_{p}}} z \left(\gamma - 1\right)}{R \gamma \theta \left(\gamma - 1\right)}\right)^{\frac{\gamma}{\gamma - 1}}
% \end{equation*}
\begin{equation}
p(z) =  \left(C - \frac{C}{\gamma} - \frac{g p_{0}^{\frac{R}{c_{p}}} z}{R \theta} + \frac{g p_{0}^{\frac{R}{c_{p}}} z}{R \gamma \theta}\right)^{\frac{\gamma}{\gamma - 1}},
\end{equation}
with constant of integration
\begin{equation}
  \label{eq:hydrostatic-balance-constant}
 C = \frac{\left(\gamma^{\frac{\gamma}{\gamma - 1}} p_{0}\right)^{\frac{\gamma - 1}{\gamma}}}{\gamma - 1},
\end{equation}
which can be obtained by setting $p(0) = p_0$.

\section{Convergence}
We first define the $L_p$ norms for $p > 0$ by
% notation: https://en.wikipedia.org/wiki/Lp_space#Lp_spaces
\begin{equation}
  \label{eq:Lp-nrom}
  \Vert f(x) \Vert = \left( \int_K \vert f(x) \vert^p d\mu  \right)^{1/p}.
\end{equation}
We start by a known analytical solution $f(x)$ and compare it to our approximation $\hat{f}(x)$.
Let $Q$ and $\hat{Q}$ denote the analytical and approximate solution at node.
We start by computing the point-wise error, and compute the cell-wise error from this.
Observe that for our broken space $\Omega$
\begin{equation}
  \label{eq:lp-norm-broken}
 \Vert f(x) \Vert = \sum_{K \in \Omega} \Vert f_K(x) \Vert_p.
\end{equation}

We are now ready to integrate the error for each cell.
The output contains the position and conserved variables of each point.
Each cell consists of $(N + 1)^d$ nodes, each associated with a quadrature weight $w_i$.
The quadrature weights are associated with the reference cuboid.
We thus need to map our element to the reference element, before we can compute the integral.

Let $V$ denote the volume (or area) of each cell.
For example, in three dimensions $V = \Delta x \, \Delta y \, \Delta z$.
The final result is then
\begin{equation}
  \Vert f_K(x) \Vert = \left( V \sum_{\bm{i}} \vert f(\bm{x}_{\bm{i}}) \vert^p w_{{\bm{i}}}  \right)^{1/p},
\end{equation}
where we used the mapping to the reference triangle (integration by substitution).

Following~\cite{dumbser2010arbitrary}, the scenario can be described in primitive variables by setting
\begin{align}
  \pressure &= \pressure_0 \cos( \bm{k} \bm{x} - \omega t ) + \pressure_b, \\
  \Qrho &= \Qrho_0 \sin (\bm{k} \bm{x} - \omega t) + \Qrho_b, \\
  \Qv &= \bm{v_0} \sin(\bm{k} \bm{x} - \omega t).
\end{align}
We set the constants to \( \left(  \pressure_0 = 0.1, \pressure_b = \gamma^{-1}, \Qrho_0 = 0.5, \Qrho_b = 1, 
\bm{v_0} = 0.25 {(1,1)}^\intercal, \bm{k} = \pi/5 {(1,1)}^\intercal \right) \).

We derive a source term by inserting this solution into the \textsc{pde} using the symbolic math toolkit \textit{SymPy}.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../main"
%%% End:
